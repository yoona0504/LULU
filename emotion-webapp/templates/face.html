{% extends "base.html" %}
{% block title %}얼굴 인식{% endblock %}

{% block styles %}
<link rel="stylesheet" href="{{ url_for('static', filename='css/face.css') }}">
{% endblock %}

{% block scripts %}
<script src="{{ url_for('static', filename='js/face.js') }}"></script>
{% endblock %}

{% block content %}
<div class="d-flex align-items-end justify-content-between mb-3">
  <h3 class="page-title mb-0">얼굴 인식</h3>
  <div class="muted small">카메라 LED가 켜져 있으면 다른 앱이 점유 중일 수 있어요</div>
</div>

<div class="dashboard-grid">
  <div class="card">
    <div class="card-header d-flex justify-content-between">
      <strong>라이브 카메라</strong>
      <span class="muted small">엔진: <span id="engine">{{ engine }}</span> · FPS: <span id="fps">–</span></span>
    </div>
    <div class="card-body">
      <div class="cam-wrap" id="camBox">
        <img id="cam" src="/video_feed" alt="camera stream">
      </div>
      <div class="d-flex align-items-center gap-3 mt-3">
        <label class="muted small" for="camScale">카메라 크기</label>
        <input type="range" id="camScale" class="form-range" min="320" max="900" value="560">
        <select id="aspect" class="form-select form-select-sm">
          <option value="4/3" selected>4:3</option>
          <option value="16/9">16:9</option>
          <option value="1/1">1:1</option>
        </select>
        <button id="camReset" class="btn btn-sm btn-outline-light">초기화</button>
      </div>
    </div>
  </div>

  <div class="d-grid gap-3">
    <div class="card">
      <div class="card-header"><strong>분석 결과</strong></div>
      <div class="card-body"><div id="meters"></div></div>
    </div>

    <div class="card">
      <div class="card-header"><strong>현재 상태</strong></div>
      <div class="card-body">
        <div class="row g-3">
          <div class="col-md-6">
            <div class="muted small">주 감정</div>
            <div id="topEmotion" class="fs-4 fw-bold text-capitalize">-</div>
          </div>
          <div class="col-md-6">
            <div class="muted small">신뢰도</div>
            <div id="confidence" class="fs-4 fw-bold">0%</div>
          </div>
        </div>
      </div>
    </div>

    <div class="card">
      <div class="card-header d-flex justify-content-between align-items-center">
        <strong>로그</strong>
        <button id="clearLog" class="btn btn-sm btn-outline-light">지우기</button>
      </div>
      <div class="card-body">
        <textarea id="log" class="form-control log-box" readonly></textarea>
      </div>
    </div>
  </div>
</div>
{% endblock %}

{% block scripts %}
<script>
  const POLL_MS = 500;
  const preferredOrder = ["angry","disgust","fear","happy","sad","surprise","neutral"];

  const metersEl = document.getElementById("meters");
  const topEmotionEl = document.getElementById("topEmotion");
  const confidenceEl = document.getElementById("confidence");
  const fpsEl = document.getElementById("fps");
  const engineEl = document.getElementById("engine");
  const logEl = document.getElementById("log");
  const clearBtn = document.getElementById("clearLog");

  clearBtn.addEventListener("click", ()=> logEl.value="");

  function log(msg){
    const t = new Date().toLocaleTimeString();
    logEl.value = `[${t}] ${msg}\n` + logEl.value;
  }

  function buildMeters(keys){
    metersEl.innerHTML = "";
    const ordered = [
      ...preferredOrder.filter(k=>keys.includes(k)),
      ...keys.filter(k=>!preferredOrder.includes(k)).sort()
    ];
    ordered.forEach(k=>{
      const row = document.createElement("div");
      row.className = "meter-row";
      row.innerHTML = `
        <div class="label">${k}</div>
        <div class="track"><div class="fill" id="fill-${k}"></div></div>
        <div class="pct" id="pct-${k}">0%</div>
      `;
      metersEl.appendChild(row);
    });
  }

  function updateMeters(probs){
    if (!probs) return;
    const keys = Object.keys(probs);
    if (!metersEl.childElementCount) buildMeters(keys);

    let bestK = "-", bestV = 0;
    keys.forEach(k=>{
      const v = Math.max(0, Math.min(1, Number(probs[k] ?? 0)));
      const pct = Math.round(v*100);
      const fill = document.getElementById(`fill-${k}`);
      const pctEl = document.getElementById(`pct-${k}`);
      if (fill) fill.style.width = pct + "%";
      if (pctEl) pctEl.textContent = pct + "%";
      if (v > bestV){ bestV = v; bestK = k; }
    });
    topEmotionEl.textContent = bestK;
    confidenceEl.textContent = Math.round(bestV*100) + "%";
  }

  async function tick(){
    try{
      const res = await fetch("/api/emotion", {cache:"no-store"});
      const ct = res.headers.get("content-type") || "";
      if (!ct.includes("application/json")){
        const txt = await res.text();
        log(`JSON 아님: ${ct} / 예: ${txt.slice(0,80)}...`);
        return;
      }
      const data = await res.json();
      if (data.engine) engineEl.textContent = data.engine;
      if (typeof data.fps === "number") fpsEl.textContent = data.fps.toFixed(1);
      const probs = data.emotions || data.probs || {};
      updateMeters(probs);
      if (data.top && data.top.label){
        topEmotionEl.textContent = data.top.label;
        if (typeof data.top.score === "number") confidenceEl.textContent = Math.round(data.top.score*100) + "%";
      }
    }catch(e){
      log("폴링 실패: " + (e?.message || e));
    }finally{
      setTimeout(tick, POLL_MS);
    }
  }

  // 카메라 컨트롤
  const cam = document.getElementById("cam");
  const camBox = document.getElementById("camBox");
  const camScale = document.getElementById("camScale");
  const aspect = document.getElementById("aspect");
  const camReset = document.getElementById("camReset");

  camBox.style.aspectRatio = "4/3";
  cam.style.width = "560px";

  camScale.addEventListener("input", ()=>{
    cam.style.width = Number(camScale.value) + "px";
  });

  aspect.addEventListener("change", ()=>{
    camBox.style.aspectRatio = aspect.value;
  });

  camReset.addEventListener("click", ()=>{
    camScale.value = 560;
    cam.style.width = "560px";
    aspect.value = "4/3";
    camBox.style.aspectRatio = "4/3";
  });

  tick();
</script>
{% endblock %}
