<!doctype html>
<html lang="ko">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>감정 분석 대시보드</title>
  <!-- Bootstrap (쉽게 카드/그리드 사용) -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
  <style>
    :root {
      --cam-max-width: 520px;   /* 카메라 뷰 최대 너비 */
      --cam-aspect: 4/3;        /* 16/9 로 바꾸고 싶으면 16/9 */
    }

    body { background: #0b0f17; color: #e8eef5; }
    .page-title { font-weight: 700; letter-spacing: -0.3px; }

    /* 레이아웃 */
    .dashboard-grid {
      display: grid;
      grid-template-columns: minmax(280px, var(--cam-max-width)) 1fr; /* 좌: 카메라, 우: 카드들 */
      gap: 16px;
    }

    @media (max-width: 992px) {
      .dashboard-grid {
        grid-template-columns: 1fr; /* 모바일/태블릿: 세로 스택 */
      }
    }

    .card { background: #111826; border: 1px solid #1b2436; color: #e8eef5; }
    .card .card-title { color: #a9c1ff; font-weight: 700; }
    .subtle { color: #9fb0c9; }

    /* 카메라 뷰 */
    .cam-wrap { position: relative; width: 100%; }
    .cam-frame { width: 100%; aspect-ratio: var(--cam-aspect); background: #000; border-radius: 12px; overflow: hidden; }
    .cam-frame img, .cam-frame video { width: 100%; height: 100%; object-fit: cover; display: block; }

    /* 막대 바 스타일 */
    .bar {
      height: 12px; border-radius: 999px; background: #1e2b45; overflow: hidden;
    }
    .bar>span { display: block; height: 100%; width: 0%; background: #3b82f6; transition: width .4s ease; }

    /* 로그 영역 */
    .log-box {
      font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace;
      font-size: 12px; line-height: 1.35; background: #0f1724; border: 1px solid #1b2436; color: #c6d3ea;
      padding: 10px; border-radius: 8px; height: 180px; overflow: auto;
    }
  </style>
</head>
<body>
  <div class="container py-4">
    <div class="d-flex align-items-end justify-content-between mb-3">
      <h1 class="page-title h3 mb-0">감정 분석 대시보드</h1>
      <div class="subtle small">카메라 LED가 켜져 있으면 다른 앱이 점유 중일 수 있어요</div>
    </div>

    <div class="dashboard-grid">
      <!-- 왼쪽: 카메라 카드 -->
      <div class="card">
        <div class="card-body">
          <div class="d-flex align-items-center justify-content-between mb-2">
            <h2 class="card-title h5 mb-0">라이브 카메라</h2>
            <div class="small subtle"><span id="engineName">엔진: 자동</span> · <span id="fps">FPS: -</span></div>
          </div>
          <div class="cam-wrap">
            <div class="cam-frame">
              <!-- Flask에서 제공하는 MJPEG 스트림 URL 로드 -->
              <img id="cam" src="/video_feed" alt="camera-stream" />
            </div>
          </div>
          <!-- 크기 컨트롤러 -->
          <div class="mt-3 d-flex gap-2 align-items-center">
            <label for="sizeRange" class="form-label mb-0 subtle small">카메라 크기</label>
            <input id="sizeRange" type="range" min="360" max="900" value="520" class="form-range" style="width: 220px;">
            <select id="aspectSelect" class="form-select form-select-sm w-auto">
              <option value="4/3" selected>4:3</option>
              <option value="16/9">16:9</option>
              <option value="1/1">1:1</option>
            </select>
          </div>
        </div>
      </div>

      <!-- 오른쪽: 카드들 -->
      <div class="d-grid gap-3">
        <!-- 감정 확률 카드 -->
        <div class="card">
          <div class="card-body">
            <h2 class="card-title h5">분석 결과</h2>
            <div id="emotionList" class="vstack gap-3">
              <!-- JS가 감정 항목을 생성/업데이트 -->
            </div>
          </div>
        </div>

        <!-- 현재 상태 카드 -->
        <div class="card">
          <div class="card-body">
            <h2 class="card-title h6 mb-2">현재 상태</h2>
            <div class="row g-2">
              <div class="col-6">
                <div class="small subtle">주 감정</div>
                <div id="topEmotion" class="fs-5">-</div>
              </div>
              <div class="col-6">
                <div class="small subtle">신뢰도</div>
                <div id="topScore" class="fs-5">-</div>
              </div>
            </div>
          </div>
        </div>

        <!-- 로그 카드 -->
        <div class="card">
          <div class="card-body">
            <div class="d-flex align-items-center justify-content-between mb-2">
              <h2 class="card-title h6 mb-0">로그</h2>
              <button id="clearLog" class="btn btn-sm btn-outline-light">지우기</button>
            </div>
            <div id="log" class="log-box"></div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <script>
    // 카메라 크기/비율 제어
    const sizeRange = document.getElementById('sizeRange');
    const aspectSelect = document.getElementById('aspectSelect');
    const html = document.documentElement;

    sizeRange.addEventListener('input', () => {
      html.style.setProperty('--cam-max-width', sizeRange.value + 'px');
    });
    aspectSelect.addEventListener('change', () => {
      html.style.setProperty('--cam-aspect', aspectSelect.value);
    });

    // 감정 분석 데이터 폴링
    const emotionList = document.getElementById('emotionList');
    const topEmotionEl = document.getElementById('topEmotion');
    const topScoreEl = document.getElementById('topScore');
    const fpsEl = document.getElementById('fps');
    const engineEl = document.getElementById('engineName');
    const logEl = document.getElementById('log');
    const clearBtn = document.getElementById('clearLog');

    clearBtn.addEventListener('click', () => logEl.textContent = '');

    const EMOTION_KEYS = ["angry","disgust","fear","happy","sad","surprise","neutral"];

    // 초기 바 UI 생성
    function ensureBars() {
      if (emotionList.children.length) return;
      EMOTION_KEYS.forEach(key => {
        const row = document.createElement('div');
        row.innerHTML = `
          <div class="d-flex justify-content-between align-items-center mb-1">
            <div class="text-capitalize">${key}</div>
            <div id="val-${key}" class="small subtle">0%</div>
          </div>
          <div class="bar"><span id="bar-${key}"></span></div>
        `;
        emotionList.appendChild(row);
      });
    }

    ensureBars();

    async function poll() {
      try {
        const res = await fetch('/api/emotion'); // Flask에서 JSON 반환해야 함
        const ct = res.headers.get('content-type') || '';
        if (!ct.includes('application/json')) {
          const text = await res.text();
          pushLog(`poll 실패: 서버가 JSON 대신 다른 응답을 보냈어요 (content-type=${ct}). 예: ${text.slice(0,80)}...`);
          return;
        }
        const data = await res.json();
        updateUI(data);
      } catch (e) {
        pushLog('poll 실패: ' + (e?.message || e));
      }
    }

    function updateUI(data) {
      // 예시 데이터 형태:
      // { engine: "fer", fps: 23.5, emotions: {happy: 0.63, neutral: 0.31, ...}, top: {label: "happy", score: 0.63} }
      if (!data) return;
      if (data.engine) engineEl.textContent = `엔진: ${data.engine}`;
      if (typeof data.fps === 'number') fpsEl.textContent = `FPS: ${data.fps.toFixed(1)}`;

      if (data.emotions) {
        EMOTION_KEYS.forEach(k => {
          const v = Math.max(0, Math.min(1, Number(data.emotions[k] ?? 0)));
          const pct = Math.round(v * 100);
          const bar = document.getElementById(`bar-${k}`);
          const val = document.getElementById(`val-${k}`);
          if (bar) bar.style.width = pct + '%';
          if (val) val.textContent = pct + '%';
        });
      }

      if (data.top) {
        topEmotionEl.textContent = data.top.label ?? '-';
        topScoreEl.textContent = typeof data.top.score === 'number' ? Math.round(data.top.score*100) + '%' : '-';
      }
    }

    function pushLog(msg) {
      const now = new Date();
      const hh = now.getHours().toString().padStart(2,'0');
      const mm = now.getMinutes().toString().padStart(2,'0');
      const ss = now.getSeconds().toString().padStart(2,'0');
      logEl.textContent = `[${hh}:${mm}:${ss}] ${msg}\n` + logEl.textContent;
    }

    // 500ms 간격 폴링 (원하면 더 길게)
    setInterval(poll, 500);
  </script>
</body>
</html>
